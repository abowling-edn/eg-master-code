webpackJsonp([0],[function(e,t,n){n(1),n(2),n(3),n(4),n(5),n(6),n(7),n(8),n(9),n(10),n(11),n(12),n(13),n(14),n(15),n(16),n(17),n(18),n(19),n(20),e.exports=n(21)},function(e,t){angular.module("egCoreMod",["cfp.hotkeys","ngFileSaver","ngCookies","ngToast"]).config(["ngToastProvider",function(e){e.configure({verticalPosition:"bottom",animation:"fade"})}])},function(e,t){angular.module("egCoreMod").factory("egStrings",["$interpolate","$rootScope",function(e,t){var n={$replace:function(t,n){return t?e(t)(n):""},titleTruncLevel:12,setPageTitle:function(e,r,o){return e?(o&&(e=n.$replace(e,o)),r?(e=e.substring(0,n.titleTruncLevel),void(t.pageTitle=n.$replace(n.PAGE_TITLE_DYNAMIC_AND_CONTEXT,{dynamic:e,context:r}))):void(t.pageTitle=e)):void(t.pageTitle=r||n.PAGE_TITLE_DEFAULT)}};return n}])},function(e,t){angular.module("egCoreMod").factory("egIDL",["$window",function(e){function t(e,t){return(e.label||e.name)>(t.label||t.name)?1:-1}var n={};return n.Clone=function(e,t){void 0===t&&(t=100);var r;if(void 0===e||null===e)return e;if(e._isfieldmapper)r=new n[e.classname],e.a&&(r.a=n.Clone(e.a,t));else{if(angular.isArray(e))r=[];else{if(!angular.isObject(e))return angular.copy(e);r={}}for(var o in e)null===e[o]||void 0===e[o]?r[o]=e[o]:e[o]._isfieldmapper?t&&(r[o]=n.Clone(e[o],t-1)):r[o]=angular.copy(e[o])}return r},n.parseIDL=function(){n.classes=e._preload_fieldmapper_IDL;for(var t in n.classes)!function(t,r){n.classes[t].core_label=n.classes[t].core?"Core sources":"Non-core sources",n.classes[t].classname=t,n[t]=function(e){this.a=e||[],this.classname=t,this._isfieldmapper=!0},angular.forEach(r,function(e,o){n[t].prototype[r[o].name]=function(e){return 1==arguments.length&&(this.a[o]=e),this.a[o]}}),e[t]=n[t]}(t,n.classes[t].fields)},n.toHash=function(e,t){if(!angular.isObject(e))return e;if(angular.isArray(e))return e.map(function(e){return n.toHash(e)});var r=e.classname?Object.keys(n.classes[e.classname].field_map):Object.keys(e),o={};return angular.forEach(r,function(r){var a=n.toHash(angular.isFunction(e[r])?e[r]():e[r],t);t&&angular.isObject(a)?angular.forEach(a,function(e,t){o[r+"."+t]=e}):void 0!==a&&(o[r]=a)}),o},n.toTypedHash=function(e){if(!angular.isObject(e))return e;if(angular.isArray(e))return e.map(function(e){return n.toTypedHash(e)});var t=e.classname?Object.keys(n.classes[e.classname].field_map):Object.keys(e),r={};return e.classname&&angular.extend(r,{_classname:e.classname}),angular.forEach(t,function(t){var o=n.toTypedHash(angular.isFunction(e[t])?e[t]():e[t]);if(void 0!==o)if(e.classname)switch(n.classes[e.classname].field_map[t].datatype){case"org_unit":r[t]=e[t]();break;case"timestamp":r[t]=null===o?o:new Date(o);break;case"bool":r[t]="t"==o||"f"!=o&&null;break;default:r[t]=o}else r[t]=o}),r},n.toString=function(e){var t="";return angular.forEach(n.classes[e.classname].fields.sort(function(e,t){return e.name<t.name?-1:1}),function(n){t+=n.name+"="+e[n.name]()+"\n"}),t},n.fromHash=function(e,t){if(!n.classes[e])return console.error("No such IDL class "+e),null;var r=new n[e];return angular.forEach(t,function(e,n){angular.isFunction(r[n])&&r[n](t[n])}),r},n.fromTypedHash=function(e){if(!angular.isObject(e))return e;if(angular.isArray(e))return e.map(function(e){return n.fromTypedHash(e)});if(e._classname){var t=new n[e._classname],r=n.classes[e._classname].field_map;return angular.forEach(r,function(r){switch(r.datatype){case"org_unit":angular.isFunction(e[r.name])?t[r.name]=e[r.name]:t[r.name](e[r.name]);break;case"timestamp":e[r.name]instanceof Date&&t[r.name](e[r.name].toISOString());break;case"bool":!0===e[r.name]?t[r.name]("t"):!1===e[r.name]&&t[r.name]("f");break;default:t[r.name](n.fromTypedHash(e[r.name]))}}),t.isnew(e._isnew),t.ischanged(e._ischanged),t.isdeleted(e._isdeleted),t}},n.flatToNestedHash=function(e){var t={};return angular.forEach(e,function(e,n){for(var r=n.split("."),o=t,a=0;a<r.length;a++){var i=r[a];if(a==r.length-1){o[i]=e;break}o[i]||(o[i]={}),o=o[i]}}),t},n.classTree={top:null},n.classTree.buildNode=function(e,r){if(!e)return null;var o=n.classes[e];return o?(r||(r={label:o.label}),r.id=e,r.from&&(r.id=r.from+"."+r.id),angular.extend(r,{idl:n[e],uplink:r.link,classname:e,struct:o,table:o.table,fields:o.fields.sort(t),links:o.fields.filter(function(e){return"link"==e.type}).sort(t),children:[]})):null},n.classTree.fleshNode=function(e){return e.children.length>0?e:(angular.forEach(e.links.sort(t),function(t){var r=t.label?t.label:t.name;e.children.push(n.classTree.buildNode(t.class,{label:r,from:e.id,link:t}))}),e)},n.classTree.setTop=function(e){return console.debug("setTop: "+e),n.classTree.top=n.classTree.fleshNode(n.classTree.buildNode(e))},n.classTree.getTop=function(){return n.classTree.top},n}])},function(e,t){angular.module("egCoreMod").factory("egEvent",function(){return{parse:function(e){function t(e){this.code=e.ilsevent,this.textcode=e.textcode,this.desc=e.desc,this.payload=e.payload,this.debug=e.stacktrace,this.servertime=e.servertime,this.ilsperm=e.ilsperm,this.ilspermloc=e.ilspermloc,this.note=e.note,this.success="SUCCESS"==this.textcode,this.toString=function(){var e="Event: "+(this.code||"")+":"+this.textcode+" -> "+new String(this.desc);return this.ilsperm&&(e+=" "+this.ilsperm+"@"+this.ilspermloc),this.note&&(e+="\n"+this.note),e}}return e&&"object"==typeof e&&"textcode"in e?new t(e):null}}})},function(e,t){angular.module("egCoreMod").factory("egNet",["$q","$rootScope","egEvent",function(e,t,n){function r(e){var t=this;angular.forEach(e,function(e,n){t[n]=e})}var o={};return o.handleResponse=function(e){if(e.evt=n.parse(e.last),e.evt){if("NO_SESSION"==e.evt.textcode)return t.$broadcast("egAuthExpired"),void e.deferred.reject();if("PERM_FAILURE"==e.evt.textcode){if(!o.handlePermFailure)return console.debug("egNet has no handlePermFailure()"),void e.deferred.notify(e.last);e.superseded=!0,o.handlePermFailure(e).then(e.deferred.resolve,e.deferred.reject,e.deferred.notify)}}e.deferred.notify(e.last)},o.request=function(t,n){var a=Array.prototype.slice.call(arguments,2),i=new r({service:t,method:n,params:a,deferred:e.defer(),superseded:!1});return console.debug("egNet "+n),new OpenSRF.ClientSession(t).request({async:!0,method:i.method,params:i.params,oncomplete:function(){i.superseded||i.deferred.resolve(i.last)},onresponse:function(e){i.last=e.recv().content(),o.handleResponse(i)},onerror:function(e){var t=i.method+" ("+i.params+")  failed.  See server logs.";console.error(t,e),i.deferred.reject(t)},onmethoderror:function(e,t,n){var r="error calling method "+i.method+" : "+t+" : "+n;console.error(r),i.deferred.reject(r)}}).send(),i.deferred.promise},o.requestWithParamList=function(e,t,n){var r=[e,t].concat(n);return o.request.apply(o,r)},o}])},function(e,t){angular.module("egCoreMod").factory("egAuth",["$q","$timeout","$rootScope","$window","$location","egNet","egHatch",function(e,t,n,r,o,a,i){var c={user:function(e){return e&&(this._user=e),this._user},OCuser:function(e){return e&&(this._OCuser=e),this._OCuser},OCtoken:function(){return i.getLoginSessionItem("eg.auth.token.oc")},OCauthtime:function(){return i.getLoginSessionItem("eg.auth.time.oc")},token:function(){return i.getLoginSessionItem("eg.auth.token")},authtime:function(){return i.getLoginSessionItem("eg.auth.time")},workstation:function(){return this.ws},authChannel:"undefined"==typeof BroadcastChannel?{}:new BroadcastChannel("eg.auth")};return c.testAuthToken=function(){var n=e.defer();i.migrateAuthCookies();var s=c.token();return s?lf.isOffline&&!o.path().match(/\/session/)?t(function(){n.resolve()}):lf.isOffline&&o.path().match(/\/session/)&&!r.navigator.onLine?t(function(){n.resolve()}):a.request("open-ils.auth","open-ils.auth.session.retrieve",s).then(function(e){e&&e.classname?(c.user(e),c.poll(),c.check_workstation(n)):(i.clearLoginSessionItems(),n.reject())}):n.reject("No authtoken found"),n.promise},c.check_workstation=function(e){var t=c.user(),n="/admin/workstation/workstations";return i.getItem("eg.workstation.all").then(function(a){if(a||(a=[]),t.wsid()){var i=a.filter(function(e){return e.id==t.wsid()})[0];if(i)return c.ws=i.name,void e.resolve()}if(o.path()==n)return void e.resolve();r.location.href="/eg/staff"+n,e.resolve()})},c.login=function(t,n){return t=angular.copy(t),n||(n={deferred:e.defer()},i.clearLoginSessionItems()),c.login_api(t).then(function(e){"SUCCESS"==e.textcode?(c.handle_login_ok(t,e),n.deferred.resolve({invalid_workstation:n.invalid_workstation})):"WORKSTATION_NOT_FOUND"==e.textcode?(n.invalid_workstation=!0,delete t.workstation,c.login(t,n)):(console.error("login failed "+js2JSON(e)),n.deferred.reject())}),n.deferred.promise},c.opChange=function(t){t=angular.copy(t),t.workstation=c.workstation();var n=e.defer();return c.login_api(t).then(function(e){"SUCCESS"==e.textcode?("persist"!=t.type&&(i.setLoginSessionItem("eg.auth.token.oc",c.token()),i.setLoginSessionItem("eg.auth.time.oc",c.authtime()),c.OCuser(c.user())),c.handle_login_ok(t,e),c.testAuthToken().then(n.resolve,function(){c.opChangeUndo().then(n.reject)})):(console.error("operator change failed "+js2JSON(e)),n.reject())}),n.promise},c.opChangeUndo=function(){return c.OCtoken()&&(c.user(c.OCuser()),i.setLoginSessionItem("eg.auth.token",c.OCtoken()),i.setLoginSessionItem("eg.auth.time",c.OCauthtime()),i.removeLoginSessionItem("eg.auth.token.oc"),i.removeLoginSessionItem("eg.auth.time.oc")),c.testAuthToken()},c.login_via_auth_proxy=function(e){return a.request("open-ils.auth_proxy","open-ils.auth_proxy.login",e)},c.login_via_auth=function(e){return a.request("open-ils.auth","open-ils.auth.authenticate.init",e.username).then(function(t){var n=angular.copy(e);return n.password=hex_md5(t+hex_md5(e.password)),a.request("open-ils.auth","open-ils.auth.authenticate.complete",n)})},c.login_api=function(e){return a.request("open-ils.auth_proxy","open-ils.auth_proxy.enabled").then(function(t){return console.log("proxy check returned "+t),1===Number(t)?c.login_via_auth_proxy(e):c.login_via_auth(e)},function(){return c.login_via_auth(e)})},c.handle_login_ok=function(e,t){c.ws=e.workstation,i.setLoginSessionItem("eg.auth.token",t.payload.authtoken),i.setLoginSessionItem("eg.auth.time",t.payload.authtime),c.poll()},c.poll=function(){c.authChannel.onmessage||(c.authChannel.onmessage=function(e){"logout"==e.data.action&&n.$broadcast("egAuthExpired",{startedElsewhere:!0})});var e=1e3*c.authtime()+5e3;e<6e4?e=6e4:e>2147483647&&(e=2147483647),t(function(){a.request("open-ils.auth","open-ils.auth.session.retrieve",c.token(),0,1).then(function(e){e&&e.classname?c.poll():n.$broadcast("egAuthExpired")})},e)},c.logout=function(e){e&&c.authChannel.postMessage&&c.authChannel.postMessage({action:"logout"}),c.token()&&(a.request("open-ils.auth","open-ils.auth.session.delete",c.token()),i.clearLoginSessionItems()),c._user=null},c}]).factory("egPerm",["$q","egNet","egAuth","egOrg",function(e,t,n,r){var o={};return o.hasPermAt=function(o,a){var i=e.defer(),c=!0;return angular.isArray(o)||(c=!1,o=[o]),t.request("open-ils.actor","open-ils.actor.user.has_work_perm_at.batch",n.token(),o).then(function(e){var t={};angular.forEach(o,function(n){var o=[];angular.forEach(e[n],function(e){o=o.concat(r.descendants(e,a))}),t[n]=o}),c||(t=t[o[0]]),i.resolve(t)}),i.promise},o.hasPermHere=function(t){var r={},a=!0;return angular.isArray(t)||(a=!1,t=[t]),null===n.user().wsid()?(console.warn("egPerm.hasPermHere() called with no workstation"),r=!!a&&t.map(function(e){return r[e]=!1}),e.when(r)):(ws_ou=Number(n.user().ws_ou()),o.hasPermAt(t,!0).then(function(e){return angular.forEach(e,function(e,t){r[t]=e.indexOf(ws_ou)>-1}),a||(r=r[t[0]]),r}))},o}])},function(e,t){angular.module("egCoreMod").factory("egPCRUD",["$q","$rootScope","egAuth","egIDL",function(e,t,n,r){function o(){var o=this;this.xact_close_mode="rollback",this.ident=i++,this.session=new OpenSRF.ClientSession("open-ils.pcrud"),this.toString=function(){return"[PCRUDContext "+this.ident+"]"},this.log=function(e){console.debug(this+": "+e)},this.err=function(e){console.error(this+": "+e)},this.connect=function(){this.log("connect");var t=e.defer();return this.session.connect({onconnect:function(){t.resolve(o)}}),t.promise},this.disconnect=function(){this.log("disconnect"),this.session.disconnect()},this.retrieve=function(e,t,r,o){return o=o||{},this.authoritative=o.authoritative,this._dispatch("open-ils.pcrud.retrieve."+e,[n.token(),t,r])},this.retrieveAll=function(e,t,n){var o={};return o[r.classes[e].pkey]={"!=":null},this.search(e,o,t,n)},this.search=function(e,t,r,o){o=o||{},this.authoritative=o.authoritative;var a=o.idlist?"id_list":"search",i="open-ils.pcrud."+a+"."+e;return o.atomic&&(i+=".atomic"),this._dispatch(i,[n.token(),t,r])},this.create=function(e){return this.CUD("create",e)},this.update=function(e){return this.CUD("update",e)},this.remove=function(e){return this.CUD("delete",e)},this.apply=function(e){return this.CUD("apply",e)},this.xactClose=function(){return this._send_request("open-ils.pcrud.transaction."+this.xact_close_mode,[n.token()])},this.xactBegin=function(){return this._send_request("open-ils.pcrud.transaction.begin",[n.token()])},this._dispatch=function(e,t){return this.authoritative?this._wrap_xact(function(){return o._send_request(e,t)}):this._send_request(e,t)},this._wrap_xact=function(t){var n=e.defer();return this.connect().then(function(){o.xactBegin().then(function(){t().then(function(e){o.xactClose().then(function(){o.disconnect(),n.resolve(e)})},function(){n.reject()},function(e){n.notify(e)})})}),n.promise},this._send_request=function(n,r){this.log("_send_request("+n+")");var a,i=e.defer();return this.session.request({method:n,params:r,onresponse:function(e){var t=e.recv();t&&(a=t.content())?i.notify(a):o.err(n+" returned no response")},oncomplete:function(){i.resolve(a)},onmethoderror:function(e,a,c){o.err(n+" failed. \ncode => "+a+"\nstatus => "+c+"\nparams => "+js2JSON(r)),401==a&&t.$broadcast("egAuthExpired"),i.reject(e)}}).send(),i.promise},this.CUD=function(t,n){return this.log("CUD(): "+t),this.cud_idx=0,this.cud_action=t,this.xact_close_mode="commit",this.cud_list=n,this.cud_deferred=e.defer(),angular.isArray(n)&&!n.classname||(this.cud_list=[n]),this._wrap_xact(function(){return o._CUD_next_request(),o.cud_deferred.promise})},this._CUD_next_request=function(){if(this.cud_idx>=this.cud_list.length)return void this.cud_deferred.resolve(this.cud_last);var e=this.cud_action,t=this.cud_list[this.cud_idx++];if("apply"==e&&(t.ischanged()&&(e="update"),t.isnew()&&(e="create"),t.isdeleted()&&(e="delete"),"apply"==e))return void this._CUD_next_request();this._send_request("open-ils.pcrud."+e+"."+t.classname,[n.token(),t]).then(function(e){o.cud_last=e,o.cud_deferred.notify(e),o._CUD_next_request()},o.cud_deferred.reject)}}var a={};angular.forEach(["connect","retrieve","retrieveAll","search","create","update","remove","apply"],function(e){a[e]=function(){var t=new o;return t[e].apply(t,arguments)}});var i=0;return a}])},function(e,t){angular.module("egCoreMod").factory("egEnv",["$q","$window","$injector","egAuth","egPCRUD","egIDL",function(e,t,n,r,o,a){var i={loaders:[],ignoreOffline:["at","acs","abaafm","aba","acsbf","acsaf"]};i.basePath="/eg/staff/",i.load=function(){if(!r.user())return e.when();var t=[],n=this.loadClasses;return console.debug("egEnv loading classes => "+n),angular.forEach(n,function(e){t.push(i.classLoaders[e]())}),angular.forEach(this.loaders,function(e){t.push(e())}),e.all(t).then(function(){console.debug("egEnv load complete")})},i.absorbTree=function(e,t,n){function r(e){o.push(e),angular.forEach(e.children(),r)}if(!i[t]||!i[t].loaded){var o=[];r(e);i.absorbList(o,t,n).tree=e}};var c;return i.absorbList=function(e,t,r){if(i[t]&&i[t].loaded)return i[t];var o,s=a.classes[t].pkey;return i[t]?(o=i[t],angular.forEach(e,function(e){i[t].map[e[s]()]||o.list.push(e)})):o={list:e,map:{}},!r&&i.ignoreOffline.indexOf(t)<0&&(c||(c=n.get("egLovefield")),c.isCacheGood(t).then(function(e){e||c.setListInOfflineCache(t,o.list)},function(){})),angular.forEach(e,function(e){o.map[e[s]()]=e}),i[t]=o,i[t].loaded=!0,o},i.loadClasses=["aou"],i.classLoaders={aou:function(){return c||(c=n.get("egLovefield")),c.reconstituteTree("aou").then(function(n){function r(e){e.children(e.children().sort(function(e,t){return e.shortname()<t.shortname()?-1:1})),angular.forEach(e.children(),r)}if(n)return e.when();if(i.aou&&i.aou.loaded)return e.when();var a=t.sessionStorage.getItem("eg.env.aou.tree");if(a){console.debug("serving org tree from cache");var c=JSON2js(a);return i.absorbTree(c,"aou"),e.when(c)}return o.search("aou",{parent_ou:null},{flesh:-1,flesh_fields:{aou:["children","ou_type"]}}).then(function(n){return r(n),t.sessionStorage.setItem("eg.env.aou.tree",js2JSON(n)),i.absorbTree(n,"aou"),e.when()})},function(){return e.when()})}},i}])},function(e,t){angular.module("egCoreMod").factory("egOrg",["$q","egEnv","egAuth","egNet","$injector",function(e,t,n,r,o){var a={};a.cachedSettings={},a.get=function(e){return"object"==typeof e?e:t.aou.map[e]},a.list=function(){return t.aou.list},a.tree=function(){return t.aou.tree},a.root=function(){return t.aou.list[0]},a.ancestors=function(e,t){var n=a.get(e);if(!n)return[];for(var r=[n];n=a.get(n.parent_ou());)r.push(n);return t?r.map(function(e){return Number(e.id())}):r},a.CanHaveUsers=function(e){return"t"==a.get(e).ou_type().can_have_users()},a.CanHaveVolumes=function(e){return"t"==a.get(e).ou_type().can_have_vols()},a.descendants=function(e,t){function n(e){o.push(e),angular.forEach(e.children(),n)}var r=a.get(e);if(!r)return[];var o=[];return n(r),t?o.map(function(e){return Number(e.id())}):o},a.fullPath=function(e,t){var n=a.ancestors(e).concat(a.descendants(e).slice(1));return t?n.map(function(e){return Number(e.id())}):n};var i=null;return a.settings=function(t,c){if(i||(i=o.get("egLovefield")),angular.isArray(t)||(t=[t]),lf.isOffline)return i.getSettingsCache(t).then(function(t){var n={};return angular.forEach(t,function(e){n[e.name]=e.value}),e.when(n)},function(){return e.when({})});if(!n.user())return e.when();var s=e.defer();c=c||n.user().ws_ou();var u=c==n.user().ws_ou();if(u){var l=[];if(angular.forEach(t,function(e){angular.isDefined(a.cachedSettings[e])||l.push(e)}),t=l,0==t.length)return e.when(a.cachedSettings)}return r.request("open-ils.actor","open-ils.actor.ou_setting.ancestor_default.batch",c,t,n.token()).then(function(e){var t={};return angular.forEach(e,function(e,n){t[n]=e?e.value:null,u&&(a.cachedSettings[n]=t[n])}),i.setSettingsCache(t).then(function(){s.resolve(u?a.cachedSettings:t)},function(){s.resolve(u?a.cachedSettings:t)})}),s.promise},a}])},function(e,t){angular.module("egCoreMod").config(["$locationProvider","$compileProvider",function(e,t){e.html5Mode(!0),t.aHrefSanitizationWhitelist(/^\s*(https?|mailto|blob):/)}]).factory("egStartup",["$q","$rootScope","$location","$window","egIDL","egAuth","egEnv","egOrg","$cookies",function(e,t,n,r,o,a,i,c,s){var u={promise:null};return i.loaders.push(function(){return c.settings(["webstaff.format.dates","webstaff.format.date_and_time","ui.staff.max_recent_patrons","ui.staff.angular_catalog.enabled","lib.timezone"]).then(function(e){t.egDateFormat=e["webstaff.format.dates"]||"shortDate",t.egDateAndTimeFormat=e["webstaff.format.date_and_time"]||"short",null===e["ui.staff.max_recent_patrons"]&&(e["ui.staff.max_recent_patrons"]=1)})}),u.expiredAuthHandler=function(e){if(lf.isOffline)return!0;console.debug("egStartup.expiredAuthHandler()");var t=!(e&&e.startedElsewhere);return a.logout(t),"/login"==n.path()||(r.location.href=n.path("/login").search({route_to:r.location.pathname+r.location.search}).absUrl(),!1)},t.$on("egAuthExpired",function(){u.expiredAuthHandler()}),u.go=function(){if(u.promise)return u.promise;var t=s.get("eg_locale");if(t){var n=t.split(/_/);OpenSRF.locale=n[0]+"-"+n[1].toUpperCase(),console.debug("Applying locale "+OpenSRF.locale)}var r=e.defer();return u.promise=r.promise,o.parseIDL(),a.testAuthToken().then(function(){i.load().then(function(){r.resolve()},function(){r.reject("egEnv did not resolve")})},function(){console.log("egAuth found no valid authtoken"),u.expiredAuthHandler()&&r.resolve()}),u.promise},u}])},function(e,t){angular.module("egCoreMod").factory("egHatch",["$q","$window","$timeout","$interpolate","$cookies","egNet","$injector",function(e,t,n,r,o,a,i){var c={};return c.msgId=1,c.messages={},c.hatchAvailable=!1,c.auth=null,c.disableServerSettings=!1,c.keyCache={},c.serverSettingSummaries={},c.onCallPrefixes=["eg.workstation"],c.keyIsOnCall=function(e){var t=!1;return angular.forEach(c.onCallPrefixes,function(n){e.match(new RegExp("^"+n))&&(t=!0)}),t},c.browserOnlyPrefixes=["eg.workstation","eg.hatch","eg.cache","current_tag_table_marc21_biblio","FFPos","FFValue"],c.keyStoredInBrowser=function(e){if(c.disableServerSettings)return!0;var t=!1;return c.browserOnlyPrefixes.forEach(function(n){e.match(new RegExp("^"+n))&&(t=!0)}),t},c.sendToHatch=function(e){var n={};angular.forEach(e,function(e,t){t.match(/deferred/)||(n[t]=e)}),console.debug("sending to Hatch: "+JSON.stringify(n)),n.from="page",t.postMessage(n,t.location.origin)},c.attemptHatchDelivery=function(t){return t.msgid=c.msgId++,t.deferred=e.defer(),c.hatchAvailable?(c.messages[t.msgid]=t,c.sendToHatch(t)):(console.error("Hatch request attempted but Hatch is not available"),t.deferred.reject(t)),t.deferred.promise},c.resolveRequest=function(e){if(!c.messages[e.msgid])return void console.error("no cached message for id = "+e.msgid);e.deferred=c.messages[e.msgid].deferred,delete c.messages[e.msgid],200==e.status?e.deferred.resolve(e.content):(console.warn("Hatch command failed with status="+e.status+" and message="+e.message),e.deferred.reject())},c.openHatch=function(){t.document.documentElement.getAttribute("hatch-is-open")&&(t.addEventListener("message",function(e){e.source==window&&e.data&&"extension"==e.data.from&&(console.debug("Hatch responded to message ID "+e.data.msgid),c.resolveRequest(e.data))}),c.hatchAvailable=!0)},c.remotePrint=function(e,t,n,r){return c.getPrintConfig(e).then(function(e){return c.attemptHatchDelivery({action:"print",settings:e,content:n,contentType:t,showDialog:r})})},c.getPrintConfig=function(e){return c.getItem("eg.print.config."+e)},c.setPrintConfig=function(e,t){return c.setItem("eg.print.config."+e,t)},c.getPrinterOptions=function(e){return c.attemptHatchDelivery({action:"printer-options",printer:e})},c.getPrinters=function(){return c.printers?e.when(c.printers):c.attemptHatchDelivery({action:"printers"}).then(function(e){return c.printers=e.sort(function(e,t){return e.name<t.name?-1:1}),c.printers},function(){return[]})},c.usePrinting=function(){return c.getLocalItem("eg.hatch.enable.printing")},c.useSettings=function(){return c.getLocalItem("eg.hatch.enable.settings")},c.useOffline=function(){return c.getLocalItem("eg.hatch.enable.offline")},c.getItem=function(t){if(console.debug("getting item: "+t),!c.keyStoredInBrowser(t))return c.getServerItem(t);var n=e.defer();return c.getBrowserItem(t).then(function(e){n.resolve(e)},function(){c.keyIsOnCall(t)&&(console.warn("Unable to getItem from Hatch: "+t+". Retrieving item from local storage instead"),n.resolve(c.getLocalItem(t))),n.reject("Unable to getItem from Hatch: "+t)}),n.promise},c.getItemBatch=function(t){var n=[],r=[];t.forEach(function(e){c.keyStoredInBrowser(e)?n.push(e):r.push(e)});var o={},a=0===r.length?e.when():c.getServerItemBatch(r).then(function(e){angular.forEach(e,function(e,t){o[t]=e})}),i=[];return n.forEach(function(e){i.push(c.getBrowserItem(e).then(function(t){o[e]=t}))}),e.all(i.concat(a)).then(function(){return o})},c.getBrowserItem=function(t){return c.useSettings()?c.hatchAvailable?c.getRemoteItem(t):e.reject():e.when(c.getLocalItem(t))},c.getRemoteItem=function(t){return void 0!=c.keyCache[t]?e.when(c.keyCache[t]):c.attemptHatchDelivery({key:t,action:"get"}).then(function(e){return c.keyCache[t]=e})},c.getLocalItem=function(e){var n=t.localStorage.getItem(e);if(null!==n&&void 0!==n)try{return JSON.parse(n)}catch(t){return console.error("Deleting invalid JSON for localItem: "+e+" => "+n),c.removeLocalItem(e),null}},c.migrateAuthCookies=function(){["eg.auth.token","eg.auth.time","eg.auth.token.oc","eg.auth.time.oc"].forEach(function(e){var t=c.getLoginSessionItem(e);t&&(o.remove(e,{path:"/eg/staff/"}),c.setLoginSessionItem(e,t))})},c.getLoginSessionItem=function(e){var t=o.get(e);if(null!=t)return JSON.parse(t)},c.getSessionItem=function(e){var n=t.sessionStorage.getItem(e);if(null!=n)return JSON.parse(n)},c.setItem=function(t,n){if(!c.keyStoredInBrowser(t))return c.setServerItem(t,n);var r=e.defer();return c.setBrowserItem(t,n).then(function(e){r.resolve(e)},function(){c.keyIsOnCall(t)&&(console.warn("Unable to setItem in Hatch: "+t+". Setting in local storage instead"),r.resolve(c.setLocalItem(t,n))),r.reject("Unable to setItem in Hatch: "+t)})},c.setBrowserItem=function(t,n){return c.useSettings()?c.hatchAvailable?c.setRemoteItem(t,n):e.reject("Unable to get item from hatch"):e.when(c.setLocalItem(t,n))},c.setServerItem=function(t,n){if(c.auth||(c.auth=i.get("egAuth")),!c.auth.token())return e.when();var r=c.serverSettingSummaries[t];if(r&&!r.has_staff_setting)return"t"===r.has_org_setting?e.when():null===n?c.removeBrowserItem(t):(console.warn("No server setting type exists for "+t),c.setBrowserItem(t,n));var o={};return o[t]=n,a.request("open-ils.actor","open-ils.actor.settings.apply.user_or_ws",c.auth.token(),o).then(function(e){return 0==e&&(console.warn("No server setting type exists for "+t),c.setLocalItem(t,n)),c.keyCache[t]=n,e})},c.getServerItem=function(t){return t in c.keyCache?e.when(c.keyCache[t]):(c.auth||(c.auth=i.get("egAuth")),c.auth.token()?a.request("open-ils.actor","open-ils.actor.settings.retrieve.atomic",[t],c.auth.token()).then(function(e){return c.handleServerItemResponse(e[0])}):e.when(null))},c.handleServerItemResponse=function(t){var n=t.name,r=t.value;if(t.has_staff_setting="t"===t.has_user_setting||"t"===t.has_workstation_setting,t.value=null,c.serverSettingSummaries[n]=t,null!==r)return e.when(c.keyCache[n]=r);if(!t.has_staff_setting)return"t"===t.has_org_setting?e.when(c.keyCache[n]=void 0):(console.warn("No server setting type exists for "+n+", using local value."),c.getBrowserItem(n));var o=e.defer();return c.getBrowserItem(n).then(function(e){if(null===e||void 0===e)return o.resolve(c.keyCache[n]=void 0);c.setServerItem(n,e).then(function(t){1==t?(console.info("setting "+n+" successfully migrated to a server setting"),c.removeBrowserItem(n)):console.error("error migrating setting to server, falling back to local value"),o.resolve(c.keyCache[n]=e)})}),o.promise},c.getServerItemBatch=function(t){if(c.auth||(c.auth=i.get("egAuth")),!c.auth.token())return e.when({});var n={};return a.request("open-ils.actor","open-ils.actor.settings.retrieve.atomic",t,c.auth.token()).then(function(t){function r(e){if(!e)return void o.resolve(n);c.handleServerItemResponse(e).then(function(o){void 0!==o&&(n[e.name]=o),t.shift(),r(t[0])})}var o=e.defer();return r(t[0]),o.promise})},c.setRemoteItem=function(e,t){return c.keyCache[e]=t,c.attemptHatchDelivery({key:e,content:t,action:"set"})},c.setLocalItem=function(e,n,r){if(void 0===r)r=JSON.stringify(n);else if(void 0===n)return;try{t.localStorage.setItem(e,r)}catch(t){console.log("localStorage.setItem (overwrite) failed for "+e+": ",t)}},c.appendItem=function(t,n){return c.useSettings()?c.hatchAvailable?c.appendRemoteItem(t,n):c.keyIsOnCall(t)?(console.warn("Unable to appendItem in Hatch: "+t+". Setting in local storage instead"),e.when(c.appendLocalItem(t,n))):(console.error("Unable to appendItem in Hatch: "+t),e.reject()):e.when(c.appendLocalItem(t,n))},c.appendRemoteItem=function(e,t){return c.keyCache[e]=t,c.attemptHatchDelivery({key:e,content:t,action:"append"})},c.appendLocalItem=function(e,n,r){void 0===r&&(r=JSON.stringify(n));var o=t.localStorage.getItem(e)||"";try{t.localStorage.setItem(e,o+r)}catch(t){console.log("localStorage.setItem (append) failed for "+e+": ",t)}},c.setLoginSessionItem=function(e,t,n){c.addLoginSessionKey(e),void 0===n&&(n=JSON.stringify(t)),o.put(e,n,{path:"/"})},c.setSessionItem=function(e,n,r){void 0===r&&(r=JSON.stringify(n)),t.sessionStorage.setItem(e,r)},c.removeItem=function(t){if(!c.keyStoredInBrowser(t))return c.removeServerItem(t);var n=e.defer();return c.removeBrowserItem(t).then(function(e){n.resolve(e)},function(){c.keyIsOnCall(t)&&(console.warn("Unable to removeItem from Hatch: "+t+". Removing item from local storage instead"),n.resolve(c.removeLocalItem(t))),n.reject("Unable to removeItem from Hatch: "+t)}),n.promise},c.removeBrowserItem=function(t){return c.useSettings()?c.hatchAvailable?c.removeRemoteItem(t):e.reject("error talking to Hatch"):e.when(c.removeLocalItem(t))},c.removeServerItem=function(e){return c.setServerItem(e,null)},c.removeRemoteItem=function(e){return delete c.keyCache[e],c.attemptHatchDelivery({key:e,action:"remove"})},c.removeLocalItem=function(e){t.localStorage.removeItem(e)},c.removeLoginSessionItem=function(e){c.removeLoginSessionKey(e),o.remove(e,{path:"/"})},c.removeSessionItem=function(e){t.sessionStorage.removeItem(e)},c.clearLoginSessionItems=function(){angular.forEach(c.getLoginSessionKeys(),function(e){c.removeLoginSessionItem(e)}),c.removeLocalItem("eg.hatch.login_keys")},c.getKeys=function(e){var t=c.getServerKeys(e);return c.getBrowserKeys(e).then(function(e){return t.then(function(t){return t.concat(e)})})},c.getRemoteKeys=function(e){return c.attemptHatchDelivery({key:e,action:"keys"})},c.getBrowserKeys=function(t){return c.useSettings()?c.getRemoteKeys(t):e.when(c.getLocalKeys(t))},c.getServerKeys=function(t,n){return c.auth||(c.auth=i.get("egAuth")),c.auth.token()?a.request("open-ils.actor","open-ils.actor.settings.staff.applied.names.authoritative.atomic",c.auth.token(),t,n):e.when({})},c.getLocalKeys=function(e){for(var n=[],r=0;null!==(k=t.localStorage.key(r++));)e&&k.substr(0,e.length)!=e||n.push(k);return n},c.getLoginSessionKeys=function(e){var t=[],n=c.getLocalItem("eg.hatch.login_keys")||[];return angular.forEach(n,function(n){e&&n.substr(0,e.length)!=e||t.push(n)}),t},c.addLoginSessionKey=function(e){var t=c.getLoginSessionKeys();t.indexOf(e)<0&&(t.push(e),c.setLocalItem("eg.hatch.login_keys",t))},c.removeLoginSessionKey=function(e){var t=c.getLoginSessionKeys().filter(function(t){return t!=e});c.setLocalItem("eg.hatch.login_keys",t)},c.copySettingsToHatch=function(t){var n=e.defer(),r=c.getLocalKeys();return angular.forEach(r,function(e){e.match(/^eg.hatch/)||(console.debug("Copying to Hatch Storage: "+e),c.setRemoteItem(e,c.getLocalItem(e)).then(function(){t&&c.removeLocalItem(e),e==r[r.length-1]&&n.resolve()}))}),n.promise},c.copySettingsToLocal=function(t){var n=e.defer();return c.getRemoteKeys().then(function(e){angular.forEach(e,function(r){c.getRemoteItem(r).then(function(o){console.debug("Copying to Local Storage: "+r),c.setLocalItem(r,o),t&&c.removeRemoteItem(r),r==e[e.length-1]&&n.resolve()})})}),n.promise},c.openHatch(),c}])},function(e,t){angular.module("egCoreMod").factory("egPrint",["$q","$window","$timeout","$http","egHatch","egAuth","egIDL","egOrg","egEnv",function(e,t,n,r,o,a,i,c,s){var u={include_settings:["circ.staff_client.receipt.alert_text","circ.staff_client.receipt.event_text","circ.staff_client.receipt.footer_text","circ.staff_client.receipt.header_text","circ.staff_client.receipt.notice_text"]};return u.template_base_path="share/print_templates/t_",u.print=function(t){return t?t.template?u.getPrintTemplate(t.template).then(function(e){t.content=e,t.content_type||(t.content_type="text/html"),u.getPrintTemplateContext(t.template).then(function(e){return t.context=e,u.print_content(t)})}):u.print_content(t):e.when()},u.fleshPrintScope=function(e){return e||(e={}),e.today=(new Date).toISOString(),lf.isOffline||(e.staff=i.toHash(a.user()),e.current_location=i.toHash(c.get(a.user().ws_ou()))),u.fetch_includes(e)},u.fetch_includes=function(e){return c.settings(u.include_settings).then(function(t){e.includes={},angular.forEach(t,function(t,n){e.includes[n.split(/\./).pop()]=t})})},u.last_print={},u.print_content=function(e){return u.fleshPrintScope(e.scope).then(function(){return(o.usePrinting()?u.print_via_hatch(e):u.print_via_browser(e)).finally(function(){u.clear_print_content()})})},u.print_via_hatch=function(t){var n;return n="text/html"==t.content_type?u.ingest_print_content(t.content_type,t.content,t.scope):e.when(t.content),n.then(function(e){return e="<html><body>"+e+"</body></html>",u.last_print.content=e,u.last_print.context=t.context||"default",u.last_print.content_type=t.content_type,u.last_print.show_dialog=t.show_dialog,o.setItem("eg.print.last_printed",u.last_print),u._remotePrint()})},u._remotePrint=function(){return o.remotePrint(u.last_print.context,u.last_print.content_type,u.last_print.content,u.last_print.show_dialog)},u.print_via_browser=function(e){var n=e.content_type,a=e.content,i=e.scope;return"text/csv"!=n&&"text/plain"!=n||(a="<pre>"+a+"</pre>"),r.get(s.basePath+"css/print.css").then(function(e){return'<style type="text/css" media="print">'+e.data+"</style>"+a}).then(function(e){return u.ingest_print_content(n,e,i)}).then(function(e){u.last_print.content=e,u.last_print.content_type=n,o.setItem("eg.print.last_printed",u.last_print),t.print()})},u.reprintLast=function(){var n=e.defer(),r=n.promise;r.finally(function(){u.clear_print_content()}),o.getItem("eg.print.last_printed").then(function(e){return e&&e.content?(u.last_print=e,o.usePrinting()?r.then(function(){o._remotePrint()}):r.then(function(){u.ingest_print_content(null,null,null,u.last_print.content).then(function(){t.print()})}),n.resolve()):n.reject()})},u.getPrintTemplate=function(t){var n=e.defer();return o.getItem("eg.print.template."+t).then(function(e){if(e)return void n.resolve(e);var o=u.template_base_path+t;console.debug("fetching template "+o),r.get(o).then(function(e){n.resolve(e.data)},function(){console.error("unable to locate print template: "+t),n.reject()})}),n.promise},u.storePrintTemplate=function(e,t){return o.setItem("eg.print.template."+e,t)},u.removePrintTemplate=function(e){return o.removeItem("eg.print.template."+e)},u.getPrintTemplateContext=function(t){var n=e.defer();return o.getItem("eg.print.template_context."+t).then(function(e){n.resolve(e)},function(){n.resolve("default")}),n.promise},u.storePrintTemplateContext=function(e,t){return o.setItem("eg.print.template_context."+e,t)},u.removePrintTemplateContext=function(e){return o.removeItem("eg.print.template_context."+e)},u}]).directive("egPrintContainer",["$compile",function(e){return{restrict:"AE",scope:{},link:function(e,t,n){e.elm=t},controller:["$scope","$q","$window","$timeout","egHatch","egPrint","egEnv",function(t,n,r,o,a,i,c){i.clear_print_content=function(){t.elm.html(""),e(t.elm.contents())(t.$new(!0))},i.ingest_print_content=function(r,a,i,c){if(c)return t.elm.html(c),n.when(c);t.elm.html(a);var s=t.$new(!0);angular.forEach(i,function(e,t){s[t]=e});var u=(e(t.elm.contents())(s),n.defer());return o(function(){u.resolve(t.elm.html())}),u.promise}}]}}])},function(e,t){angular.module("egCoreMod").factory("egAudio",["$q","egHatch",function(e,t){var n={url_cache:{},base_url:"/audio/notifications/"};return n.play=function(e){e&&n.play_url(e,e)},n.play_url=function(e,r){console.log("audio: play_url("+e+","+r+")"),t.getItem("eg.audio.disable").then(function(t){if(!t){var o=n.url_cache[e]||n.base_url+e.replace(/\./g,"/")+".wav",a=new Audio(o);if(a.onloadeddata=function(){n.url_cache[r]=o,a.play(),console.log("audio: "+o)},n.url_cache[e])return;a.onerror=function(){if(!e.match(/\./))return void console.warn("No suitable URL found for path '"+r+"'");e=e.replace(/\.[^\.]+$/,""),n.play_url(e,r)}}})},n}])},function(e,t){angular.module("egCoreMod").factory("egCore",["egIDL","egNet","egEnv","egOrg","egPCRUD","egEvent","egAuth","egPerm","egHatch","egPrint","egStartup","egStrings","egAudio","egDate","egI18N",function(e,t,n,r,o,a,i,c,s,u,l,f,d,g,h){return{idl:e,net:t,env:n,org:r,pcrud:o,evt:a,auth:i,perm:c,hatch:s,print:u,startup:l,strings:f,audio:d,date:g,i18n:h}}])},function(e,t){angular.module("egUserMod",["egCoreMod"]).factory("egUser",["$q","$timeout","egNet","egAuth","egOrg",function(e,t,n,r,o){var a={defaultFleshFields:["card","settings","standing_penalties","addresses","billing_address","mailing_address","stat_cat_entries","waiver_entries","usr_activity","notes"]};return a.format_name=function(e){return(e.prefix()?e.prefix()+" ":"")+e.family_name()+", "+e.first_given_name()+" "+(e.second_given_name()?e.second_given_name()+" ":"")+(e.suffix()?e.suffix():"")},a.get=function(t,o){var i=e.defer();t||i.reject();var c=a.defaultFleshFields;return o&&(o.useFields&&(c=o.useFields),o.addFields&&(c=c.concat(o.addFields))),n.request("open-ils.actor","open-ils.actor.user.fleshed.retrieve",r.token(),t,c).then(function(e){e&&"au"==e.classname?i.resolve(e):i.reject(e)}),i.promise},a.getByBarcode=function(e,t){return n.request("open-ils.pcrud","open-ils.pcrud.search.ac.atomic",r.token(),{barcode:e}).then(function(e){return e&&angular.isArray(e)&&e[0]&&"ac"==e[0].classname?a.get(e[0].usr(),t):a.get(null)})},a}])},function(e,t){angular.module("egCoreMod").directive("egNavbar",function(){return{restrict:"AE",transclude:!0,templateUrl:"eg-navbar-template",controller:["$scope","$window","$location","$timeout","hotkeys","$rootScope","egCore","$uibModal","ngToast","egOpChange","$element","egLovefield",function(e,t,n,r,o,a,i,c,s,u,l,f){function d(e){e=e.replace(/^\.\//,""),t.location.href=i.env.basePath+e}function g(t){t=angular.element(t),t.attr("eg-accesskey")&&e.addHotkey(t.attr("eg-accesskey"),t.attr("href"),t.attr("eg-accesskey-desc"),t),angular.forEach(t.children(),g)}e.rs=a,e.reprintLast=function(e){return i.print.reprintLast(),e.preventDefault()},e.addHotkey=function(e,t,n,a){angular.forEach(e.split(" "),function(e){o.add({combo:e,allowIn:["INPUT","SELECT","TEXTAREA"],description:n,callback:function(e){return e.preventDefault(),t?d(t):r(function(){$(a).trigger("click")})}})})},e.retrieveLastRecord=function(){var e=i.hatch.getLocalItem("eg.cat.last_record_retrieved");e&&(t.location.href=i.env.basePath+"cat/catalog/record/"+e)},e.applyLocale=function(e){t.location.href=i.env.basePath+"?set_eg_locale="+encodeURIComponent(e)},e.changeOperatorUndo=function(){u.changeOperatorUndo().then(function(){e.op_changed=!1,e.username=i.auth.user().usrname()})},e.changeOperator=function(){u.changeOperator().then(function(){e.op_changed=!!i.auth.OCtoken(),e.username=i.auth.user().usrname()})},e.currentToken=function(){return i.auth.token()},e.hatchConnected=function(){return i.hatch.hatchAvailable},e.logout=function(){return i.auth.logout(),!0},e.offlineDisabled=function(){return f.cannotConnect},i.startup.go().then(function(){i.auth.user()&&(e.op_changed=!!i.auth.OCtoken(),e.username=i.auth.user().usrname(),e.workstation=i.auth.workstation(),i.org.settings(["ui.staff.max_recent_patrons","ui.staff.angular_catalog.enabled"]).then(function(t){var n=t["ui.staff.max_recent_patrons"];e.showRecentPatron=n>0,e.showRecentPatrons=n>1,e.showAngularCatalog=t["ui.staff.angular_catalog.enabled"]})),r(function(){g(l)})})}]}})},function(e,t){angular.module("egUiMod",["egCoreMod","ui.bootstrap"]).directive("focusMe",["$timeout","$parse",function(e,t){return{link:function(n,r,o){var a=t(o.focusMe);n.$watch(a,function(t){!0===t&&e(function(){r[0].focus()})}),r.bind("blur",function(){e(function(){a.assign&&"function"==typeof a.assign&&n.$apply(a.assign(n,!1))})})}}}]).directive("blurMe",["$timeout","$parse",function(e,t){return{link:function(n,r,o){var a=t(o.blurMe);n.$watch(a,function(t){!0===t&&e(function(){r[0].blur()})}),r.bind("focus",function(){e(function(){n.$apply(a.assign(n,!1))})})}}}]).directive("selectMe",["$timeout","$parse",function(e,t){return{link:function(n,r,o){var a=t(o.selectMe);n.$watch(a,function(t){!0===t&&e(function(){r[0].select()})}),r.bind("blur",function(){e(function(){n.$apply(a.assign(n,!1))})})}}}]).directive("intToStr",function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,r){r.$parsers.push(function(e){return parseInt(e)}),r.$formatters.push(function(e){return""+e})}}}).directive("strToInt",function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,r){r.$parsers.push(function(e){return""+e}),r.$formatters.push(function(e){return parseInt(e)})}}}).directive("floatToStr",function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,r){r.$parsers.push(function(e){return parseFloat(e)}),r.$formatters.push(function(e){return""+e})}}}).directive("strToFloat",function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,r){r.$parsers.push(function(e){return""+e}),r.$formatters.push(function(e){return parseFloat(e)})}}}).filter("reverse",function(){return function(e){return e.slice().reverse()}}).filter("date",function(){var e={short:"l LT",medium:"lll",long:"LLL",full:"LLLL",shortDate:"l",mediumDate:"ll",longDate:"LL",fullDate:"LL",shortTime:"LT",mediumTime:"LTS"},t=[[/yyyy/g,"YYYY"],[/yy/g,"YY"],[/y/g,"Y"],[/ww/g,"WW"],[/w/g,"W"],[/dd/g,"DD"],[/d/g,"D"],[/sss/g,"SSS"],[/EEEE/g,"dddd"],[/EEE/g,"ddd"],[/Z/g,"ZZ"]];return function(n,r,o){if(!n)return"";if("now"==n&&(n=(new Date).toISOString()),r){var a=e[r]||r;angular.forEach(t,function(e){a=a.replace(e[0],e[1])})}var i=moment(n);return o&&"-"!==o&&i.tz(o),i.isValid()?i.format(a):""}}).filter("egOrgDate",["$filter","egCore",function(e,t){function n(n,o,a){return a&&(angular.isObject(a)&&(a=angular.isFunction(a.id)?a.id():a.id),r[a]||(r[a]="-",t.org.settings("lib.timezone",a).then(function(e){r[a]=e["lib.timezone"]||OpenSRF.tz}))),e("date")(n,o,r[a])}var r={};return n.$stateful=!0,n}]).filter("egOrgDateInContext",["$filter","egCore",function(e,t){function n(n,r,o,a){var i=r;if(i||(i="short"),["short","medium","long","full"].filter(function(e){return i==e}).length>0&&a){var c=t.date.intervalToSeconds(a);null!==c&&c%86400==0&&(i+="Date")}return e("egOrgDate")(n,i,o)}return n.$stateful=!0,n}]).filter("egDueDate",["$filter","egCore",function(e,t){function n(n,r,o,a){if(a){var i=t.date.intervalToSeconds(a);null!==i&&i%86400==0||(o=null,a=null)}return e("egOrgDateInContext")(n,r,o,a)}return n.$stateful=!0,n}]).filter("join",function(){return function(e,t){return"object"==typeof e&&e.constructor==Array?e.join(t||","):""}}).factory("egProgressData",[function(){var e={};return e.reset=function(){delete e.max,delete e.value},e.hasvalue=function(){return Number.isInteger(e.value)},e.hasmax=function(){return Number.isInteger(e.max)},e.percent=function(){return e.hasvalue()&&e.hasmax()&&e.max>0&&e.value<=e.max?Math.floor(e.value/e.max*100):100},e}]).factory("egProgressDialog",["egProgressData","$uibModal",function(e,t){var n={};return n.open=function(e){return t.open({templateUrl:"./share/t_progress_dialog",controller:["$scope","$uibModalInstance","egProgressData",function(t,r,o){n.close(!0),o.reset(),n.update(angular.extend({},e)),n.currentInstance=r,t.data=o}]})},n.close=function(e){n.currentInstance&&(e&&console.warn("egProgressDialog replacing existing instance. Only one may be open at a time."),n.currentInstance.close(),delete n.currentInstance)},n.update=function(t){void 0!=t.max&&(e.max=t.max),void 0!=t.value&&(e.value=t.value),void 0!=t.label&&(e.label=t.label)},n.increment=function(t){Number.isInteger(t)||(t=1),e.hasvalue()||(e.value=0),e.value+=t},n}]).factory("egAlertDialog",["$uibModal","$interpolate",function(e,t){var n={};return n.open=function(n,r){return e.open({templateUrl:"./share/t_alert_dialog",backdrop:"static",controller:["$scope","$uibModalInstance",function(e,o){e.message=t(n)(r),e.ok=function(){r&&r.ok&&r.ok(),o.close()}}]})},n}]).factory("egConfirmDialog",["$uibModal","$interpolate",function(e,t){var n={};return n.open=function(n,r,o,a,i){return o=o||{},e.open({templateUrl:"./share/t_confirm_dialog",backdrop:"static",controller:["$scope","$uibModalInstance",function(e,c){e.title=t(n)(o),e.message=t(r)(o),e.ok_button_label=t(a||"")(o),e.cancel_button_label=t(i||"")(o),e.ok=function(){o.ok&&o.ok(),c.close()},e.cancel=function(){o.cancel&&o.cancel(),c.dismiss()}}]})},n}]).factory("egPromptDialog",["$uibModal","$interpolate",function(e,t){var n={};return n.open=function(n,r,o){return e.open({templateUrl:"./share/t_prompt_dialog",backdrop:"static",controller:["$scope","$uibModalInstance",function(e,a){e.message=t(n)(o),e.args={value:r||""},e.focus=!0,e.ok=function(){o&&o.ok&&o.ok(e.args.value),a.close(e.args)},e.cancel=function(){o&&o.cancel&&o.cancel(),a.dismiss()}}]})},n}]).factory("egSelectDialog",["$uibModal","$interpolate",function(e,t){var n={};return n.open=function(n,r,o,a){return e.open({templateUrl:"./share/t_select_dialog",backdrop:"static",controller:["$scope","$uibModalInstance",function(e,i){e.message=t(n)(a),e.args={list:r,value:o},e.focus=!0,e.ok=function(){a.ok&&a.ok(e.args.value),i.close()},e.cancel=function(){a.cancel&&a.cancel(),i.dismiss()}}]})},n}]).factory("egUnloadPrompt",["$window","egStrings",function(e,t){var n={attached:!1};return n.attach=function(r,o){n.attached||(n.attached=!0,$(e).on("beforeunload",function(){return n.clear(),o||t.EG_UNLOAD_PAGE_PROMPT_MSG}),r&&(n.locChangeCancel=r.$on("$locationChangeStart",function(e,r,a){confirm(o||t.EG_UNLOAD_CTRL_PROMPT_MSG)?n.clear():e.preventDefault()})))},n.clear=function(){$(e).off("beforeunload"),n.locChangeCancel&&n.locChangeCancel(),n.attached=!1},n}]).factory("egAddCopyAlertDialog",["$uibModal","$interpolate","egCore",function(e,t,n){var r={};return r.open=function(t){return e.open({templateUrl:"./share/t_add_copy_alert_dialog",controller:["$scope","$q","$uibModalInstance",function(e,r,o){e.copy_ids=t.copy_ids,n.pcrud.search("ccat",{active:"t"},{},{atomic:!0}).then(function(t){e.alert_types=t}),e.copy_alert={create_staff:n.auth.user().id(),note:"",temp:!1},e.ok=function(r){void 0!==r.note&&""!=r.note?(copy_alerts=[],angular.forEach(e.copy_ids,function(t){var o=new n.idl.aca;o.isnew(1),o.create_staff(r.create_staff),o.note(r.note),o.temp(r.temp?"t":"f"),o.copy(t),o.ack_time(null),o.alert_type(e.alert_types.filter(function(e){return e.id()==r.alert_type})[0]),copy_alerts.push(o)}),copy_alerts.length>0&&n.pcrud.apply(copy_alerts).finally(function(){t.ok&&t.ok(),o.close()})):(t.ok&&t.ok(),o.close())},e.cancel=function(){t.cancel&&t.cancel(),o.dismiss()}}]})},r}]).factory("egCopyAlertManagerDialog",["$uibModal","$interpolate","egCore",function(e,t,n){var r={};return r.get_user_copy_alerts=function(e){return n.pcrud.search("aca",{copy:e,ack_time:null},{flesh:1,flesh_fields:{aca:["alert_type"]}},{atomic:!0})},r.open=function(t){return e.open({templateUrl:"./share/t_copy_alert_manager_dialog",controller:["$scope","$q","$uibModalInstance",function(e,o,a){e.get_copy_statuses=function(){return n.env.ccs?o.when(n.env.ccs.list):n.pcrud.retrieveAll("ccs",null,{atomic:!0}).then(function(e){return n.env.absorbList(e,"ccs"),e})},e.mode=t.mode||"checkin";var i=[],c={};e.next_statuses=[],e.params={the_next_status:null},function(e){var t=o.defer();return e.copy_id?r.get_user_copy_alerts(e.copy_id).then(function(e){t.resolve(e)}):t.resolve(e.alerts),t.promise}(t).then(function(t){e.alerts=t,angular.forEach(e.alerts,function(e){var t=e.alert_type().state();e.evt=e.alert_type().event(),e.message=e.note()||n.strings.ON_DEMAND_COPY_ALERT[e.evt][t],"t"==e.temp()&&angular.forEach(e.alert_type().next_status(),function(e){c[e]||(c[e]=!0,i.push(e))})}),"checkin"==e.mode&&i.length>0&&e.get_copy_statuses().then(function(){angular.forEach(i,function(t){n.env.ccs.map[t]&&e.next_statuses.push(n.env.ccs.map[t])}),e.params.the_next_status=e.next_statuses[0].id()})}),e.isAcknowledged=function(e){return e.acked},e.canBeAcknowledged=function(e){return!e.ack_time()&&"t"==e.temp()},e.canBeRemoved=function(e){return!e.ack_time()&&"f"==e.temp()},e.ok=function(){var r=[];angular.forEach(e.alerts,function(e){e.acked&&(e.ack_time("now"),e.ack_staff(n.auth.user().id()),e.ischanged(!0),r.push(e))}),r.length>0?n.pcrud.apply(r).finally(function(){t.ok&&t.ok(e.params.the_next_status),a.close()}):(t.ok&&t.ok(e.params.the_next_status),a.close())},e.cancel=function(){t.cancel&&t.cancel(),a.dismiss()}}]})},r}]).factory("egCopyAlertEditorDialog",["$uibModal","$interpolate","egCore",function(e,t,n){var r={};return r.get_user_copy_alerts=function(e){return n.pcrud.search("aca",{copy:e,ack_time:null},{flesh:1,flesh_fields:{aca:["alert_type"]}},{atomic:!0})},r.get_copy_alert_types=function(){return n.pcrud.search("ccat",{active:"t"},{},{atomic:!0})},r.open=function(t){return e.open({templateUrl:"./share/t_copy_alert_editor_dialog",controller:["$scope","$q","$uibModalInstance",function(e,o,a){(function(e){var t=o.defer();return e.copy_id?r.get_user_copy_alerts(e.copy_id).then(function(e){t.resolve(e)}):t.resolve(e.alerts),t.promise})(t).then(function(t){e.copy_alert_list=t}),r.get_copy_alert_types().then(function(t){e.alert_types=t}),e.ok=function(){n.pcrud.apply(e.copy_alert_list).finally(function(){a.close()})},e.cancel=function(){t.cancel&&t.cancel(),a.dismiss()}}]})},r}]).directive("aDisabled",function(){return{restrict:"A",compile:function(e,t,n){return t.ngClick="!("+t.aDisabled+") && ("+t.ngClick+")",function(e,t,n){e.$watch(n.aDisabled,function(e){void 0!==e&&t.toggleClass("disabled",e)}),t.on("click",function(t){e.$eval(n.aDisabled)&&t.preventDefault()})}}}}).directive("egBasicComboBox",function(){return{restrict:"E",replace:!0,scope:{list:"=",selected:"=",onSelect:"=",egDisabled:"=",allowAll:"@",placeholder:"@",focusMe:"=?"},template:'<div class="input-group"><input placeholder="{{placeholder}}" type="text" ng-disabled="egDisabled" class="form-control" ng-model="selected" ng-change="makeOpen()" focus-me="focusMe"><div class="input-group-btn" uib-dropdown ng-class="{open:isopen}"><button type="button" ng-click="showAll()" ng-disabled="egDisabled" class="btn btn-default" uib-dropdown-toggle><span class="caret"></span></button><ul uib-dropdown-menu class="dropdown-menu-right"><li ng-repeat="item in list|filter:selected:compare"><a href ng-click="changeValue(item)">{{item}}</a></li><li ng-if="complete_list" class="divider"><span></span></li><li ng-if="complete_list" ng-repeat="item in list"><a href ng-click="changeValue(item)">{{item}}</a></li></ul></div></div>',controller:["$scope","$filter",function(e,t){e.complete_list=!1,e.isopen=!1,e.clickedopen=!1,e.clickedclosed=null,e.compare=function(e,t){return null===t||void 0===t||(t.toString&&(t=t.toString()),new RegExp(t.toLowerCase()).test(e))},e.showAll=function(){e.clickedopen=!e.clickedopen,null===e.clickedclosed?e.clickedopen||(e.clickedclosed=!0):e.clickedclosed=!e.clickedopen,e.selected&&e.selected.length>0&&(e.complete_list=!0),e.selected&&0!=e.selected.length||(e.complete_list=!1),e.makeOpen()},e.makeOpen=function(){e.isopen=e.clickedopen||t("filter")(e.list,e.selected).length>0&&e.selected&&e.selected.length>0,e.clickedclosed&&(e.isopen=!1,e.clickedclosed=null)},e.changeValue=function(t){e.selected=t,e.isopen=!1,e.clickedclosed=null,e.clickedopen=!1,0==e.selected.length&&(e.complete_list=!1),e.onSelect&&e.onSelect()}}]}}).directive("egListCounts",function(){return{restrict:"E",replace:!0,scope:{label:"@",list:"=",render:"=",onSelect:"="},templateUrl:"./share/t_listcounts",controller:["$scope","$timeout",function(e,t){e.isopen=!1,e.count_hash={},e.renderer=e.render?e.render:function(e){return""+e},e.$watchCollection("list",function(){e.count_hash={},angular.forEach(e.list,function(t){var n=e.renderer(t);e.count_hash[n]?e.count_hash[n].count++:e.count_hash[n]={count:1,value:n,original:t}})}),e.selectValue=function(t){e.onSelect&&e.onSelect(t)}}]}}).directive("egOrgSelector",function(){return{restrict:"AE",transclude:!0,replace:!0,scope:{selected:"=",hiddenTest:"=",disableTest:"=",alldisabled:"@",onchange:"=",label:"@",stickySetting:"@"},templateUrl:"./share/t_org_select",controller:["$scope","$timeout","egCore","egStartup","$q",function(e,t,n,r,o){function a(e){return" ".repeat(e.ou_type().depth())+e.shortname()}function i(){e.selected&&e.onchange&&t(function(){console.debug("egOrgSelector onchange("+e.selected.id()+")"),e.onchange(e.selected)})}function c(){u=e.$watch("selected",function(t,n){e.selectedName=t?t.shortname():""})}function s(){u&&(u(),u=null)}r.go().then(function(){return n.env.classLoaders.aou()}).then(function(){if(e.selecteName="",e.shortNames=n.org.list().filter(function(t){return!(e.hiddenTest&&e.hiddenTest(t.id()))}).map(function(e){return a(e)}),e.stickySetting){var t=n.hatch.getLocalItem(e.stickySetting);if(t){var r=n.org.get(t);r&&(e.selected=r,e.selectedName=r.shortname())}}if(!e.selected&&!e.nodefault&&n.auth.user()){var r=n.org.get(n.auth.user().ws_ou());e.selected=r,e.selectedName=r.shortname()}i(),c()}),e.handleClick=function(n){t(function(){var t=e.selectedName;$(n.target).val(""),$(n.target).trigger("input"),e.selectedName=t})},e.compare=function(e,t){return"_INTERNAL_"===t||(e||"").toLowerCase().trim().indexOf((t||"").toLowerCase().trim())>-1},e.formatDisplayName=function(t){return(e.selectedName||"").trim()},e.orgIsDisabled=function(t){if("true"===e.alldisabled)return!0;if(t&&e.disableTest){var r=n.org.list().filter(function(e){return e.shortname()===t.trim()})[0];return r&&e.disableTest(r.id())}return!1},e.inputChanged=function(r){s(),e.selectedName&&!e.orgIsDisabled(e.selectedName)?e.selected=n.org.list().filter(function(t){return t.shortname()===e.selectedName.trim()})[0]:e.selected=null,e.selected&&e.stickySetting&&n.hatch.setLocalItem(e.stickySetting,e.selected.id()),i(),t(c)};var u}],link:function(e,t,n,r){angular.forEach(["nodefault"],function(t){angular.isDefined(n[t])?e[t]=!0:e[t]=!1})}}}).directive("emptyTypeahead",function(){return{require:"ngModel",link:function(e,t,n,r){r.$parsers.unshift(function(e){var t=e||"_INTERNAL_";return r.$viewValue=t,t}),r.$parsers.push(function(e){return"_INTERNAL_"===e?"":e})}}}).directive("nextOnEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(e){13===e.which&&($("#"+n.nextOnEnter).focus(),e.preventDefault())})}}).directive("egEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.egEnter)}),t.preventDefault())})}}).directive("egDateInput",["egStrings","egCore",function(e,t){return{scope:{id:"@",closeText:"@",ngModel:"=",ngChange:"=",ngBlur:"=",minDate:"=?",maxDate:"=?",ngDisabled:"=",ngRequired:"=",hideDatePicker:"=",hideTimePicker:"=?",dateFormat:"=?",outOfRange:"=?",focusMe:"=?"},require:"ngModel",templateUrl:"./share/t_datetime",replace:!0,controller:["$scope",function(e){e.options={minDate:e.minDate,maxDate:e.maxDate};var t=e.maxDate?new Date(e.maxDate):null,n=e.minDate?new Date(e.minDate):null;void 0!==e.outOfRange&&(t||n)&&e.$watch("ngModel",function(r,o){if(r&&r!=o){var a=!1,i=new Date(r);t&&i.getTime()>t.getTime()&&(a=!0),n&&i.getTime()<n.getTime()&&(a=!0),e.outOfRange=a}})}],link:function(n,r,o){n.closeText||(n.closeText=e.EG_DATE_INPUT_CLOSE_TEXT),"showTimePicker"in o&&(n.showTimePicker=!0);var a="mediumDate";t.org.settings(["format.date"]).then(function(e){e&&(a=e["format.date"]),n.date_format=n.dateFormat?n.dateFormat:a})}}}]).directive("egFmValueSelector",function(){return{restrict:"E",transclude:!0,scope:{idlClass:"@",ngModel:"=",filter:"=",stickySetting:"@",ouSetting:"@"},require:"ngModel",templateUrl:"./share/t_fm_value_selector",controller:["$scope","egCore",function(e,t){function n(e,n){var r,o,a=[],i=t.idl.classes[e].fields;return angular.forEach(i,function(e){if("id"==e.datatype)return r=e.name,void(o=e.selector?e.selector:r)}),angular.forEach(n,function(e){var n=t.idl.toHash(e);a.push({id:n[r],name:n[o]})}),a}e.org=t.org,e.auth=t.auth,e.hatch=t.hatch;var r={};r[t.idl.classes[e.idlClass].pkey]={"!=":null},e.filter&&angular.extend(r,e.filter),t.pcrud.search(e.idlClass,r,{},{atomic:!0}).then(function(t){e.linked_values=n(e.idlClass,t)}),e.handleChange=function(n){e.stickySetting&&t.hatch.setLocalItem(e.stickySetting,n)}}],link:function(e,t,n){if(e.stickySetting&&(angular.isUndefined(e.ngModel)||null===e.ngModel)){var r=e.hatch.getLocalItem(e.stickySetting);e.ngModel=r}e.ouSetting&&(angular.isUndefined(e.ngModel)||null===e.ngModel)&&e.org.settings([e.ouSetting],e.auth.user().ws_ou()).then(function(t){var n=parseInt(t[e.ouSetting]);isNaN(n)||(e.ngModel=n)})}}}).directive("egShareDepthSelector",function(){return{restrict:"E",transclude:!0,scope:{ngModel:"="},require:"ngModel",templateUrl:"./share/t_share_depth_selector",controller:["$scope","egCore",function(e,t){e.values=[],t.pcrud.search("aout",{id:{"!=":null}},{order_by:{aout:["depth","name"]}},{atomic:!0}).then(function(t){var n=[];angular.forEach(t,function(e){var t=parseInt(e.depth());t in n?n[t].push(e.name()):n[t]=[e.name()]}),n.forEach(function(t,r){e.values.push({id:r,name:n[r].join(" / ")})})})}]}}).directive("egHelpPopover",function(){return{restrict:"E",transclude:!0,scope:{helpText:"@",helpLink:"@"},templateUrl:"./share/t_help_popover",controller:["$scope","$sce",function(e,t){e.helpLink&&(e.helpHtml=t.trustAsHtml('<a target="_new" href="'+e.helpLink+'">'+e.helpText+"</a>"))}]}}).factory("egWorkLog",["egCore",function(e){var t={};return t.retrieve_all=function(){return{work_log:e.hatch.getLocalItem("eg.work_log")||[],patron_log:e.hatch.getLocalItem("eg.patron_log")||[]}},t.record=function(t,n){var r,o;void 0!==e?void 0!==e.env?void 0!==e.env.aous?(r=e.env.aous["ui.admin.work_log.max_entries"],o=e.env.aous["ui.admin.patron_log.max_entries"]):console.log("worklog: missing egCore.env.aous"):console.log("worklog: missing egCore.env"):console.log("worklog: missing egCore"),r||(void 0!==e.org?void 0!==e.org.cachedSettings?r=e.org.cachedSettings["ui.admin.work_log.max_entries"]:console.log("worklog: missing egCore.org.cachedSettings"):console.log("worklog: missing egCore.org")),o||(void 0!==e.org?void 0!==e.org.cachedSettings?o=e.org.cachedSettings["ui.admin.patron_log.max_entries"]:console.log("worklog: missing egCore.org.cachedSettings"):console.log("worklog: missing egCore.org")),r||(r=20,console.log("worklog: defaulting to max_entries = "+r)),o||(o=10,console.log("worklog: defaulting to max_patrons = "+o));var a=e.hatch.getLocalItem("eg.work_log")||[],i=e.hatch.getLocalItem("eg.patron_log")||[],c={when:new Date,msg:t,action:n.action,actor:e.auth.user().usrname()};if("checkin"==n.action&&(c.item=n.response.params.copy_barcode,c.item_id=n.response.data.acp.id(),n.response.data.au&&(c.user=n.response.data.au.family_name(),c.patron_id=n.response.data.au.id())),"checkout"==n.action&&(c.item=n.response.params.copy_barcode,c.user=n.response.data.au.family_name(),c.item_id=n.response.data.acp.id(),c.patron_id=n.response.data.au.id()),"noncat_checkout"==n.action&&(c.user=n.response.data.au.family_name(),c.patron_id=n.response.data.au.id()),"renew"==n.action&&(c.item=n.response.params.copy_barcode,c.user=n.response.data.au.family_name(),c.item_id=n.response.data.acp.id(),c.patron_id=n.response.data.au.id()),"requested_hold"!=n.action&&"edited_patron"!=n.action&&"registered_patron"!=n.action&&"paid_bill"!=n.action||(c.patron_id=n.patron_id),"requested_hold"==n.action&&(c.hold_id=n.hold_id),"paid_bill"==n.action&&(c.amount=n.total_amount),a.push(c),a.length>r&&a.shift(),e.hatch.setLocalItem("eg.work_log",a),c.patron_id){for(var s=[],u=0;u<i.length;u++)i[u].patron_id!=c.patron_id&&s.push(i[u]);s.push(c),s.length>o&&s.shift(),i=s,e.hatch.setLocalItem("eg.patron_log",i)}console.log("worklog",c)},t}])},function(e,t){angular.module("egCoreMod").factory("egI18N",["egStrings",function(e){return{ou_qualified_location_name:function(t){return e.$replace(e.LOCATION_NAME_OU_QUALIFIED,{location_name:t.name(),owning_lib_shortname:t.owning_lib().shortname()})}}}])},function(e,t){angular.module("egCoreMod").factory("egDate",function(){var e={};return e.intervalToSeconds=function(e){for(var t=new Date,n=t.getTime(),r=e.split(" "),o=0;o<r.length;o+=2)if(r[o+1]){var a=Number(r[o]),i=r[o+1].replace(/s?,?$/,"");i.match(/^s/)?t.setSeconds(t.getSeconds()+a):i.match(/^min/)?t.setMinutes(t.getMinutes()+a):i.match(/^h/)?t.setHours(t.getHours()+a):i.match(/^d/)?t.setDate(t.getDate()+a):i.match(/^mon/)?t.setMonth(t.getMonth()+a):i.match(/^y/)&&t.setFullYear(t.getFullYear()+a)}else{var c=r[o].split(":");t.setHours(t.getHours()+Number(c[0])),t.setMinutes(t.getMinutes()+Number(c[1])),t.setSeconds(t.getSeconds()+Number(c[2]))}return Number((t.getTime()-n)/1e3)},e})},function(e,t){angular.module("egCoreMod").factory("egOpChange",["$uibModal","$interpolate","$rootScope","$q","egAuth","egStrings","egNet","ngToast",function(e,t,n,r,o,a,i,c){var s={};return s.changeOperator=function(t){return e.open({templateUrl:"./share/t_opchange",backdrop:"static",controller:["$scope","$uibModalInstance",function(e,n){e.args={username:"",password:"",type:"temp"},e.title=a.OP_CHANGE_TITLE,t?(e.title=t.desc+": "+t.ilsperm,e.message=a.OP_CHANGE_PERM_MESSAGE):e.displayTypeField=!0,e.focus=!0,e.ok=function(){n.close(e.args)},e.cancel=function(){n.dismiss()}}]}).result.then(function(e){return e&&e.username&&e.password?(e.type=e.type||"temp",e.workstation=o.workstation(),o.opChange(e).then(function(){console.debug("op-change succeeded"),t?c.create(a.PERM_OP_CHANGE_SUCCESS):c.create(a.OP_CHANGE_SUCCESS)},function(){console.debug("op-change failed"),t?c.warning(a.PERM_OP_CHANGE_FAILURE):c.warning(a.OP_CHANGE_FAILURE)})):r.reject()})},s.changeOperatorUndo=function(e){return o.opChangeUndo().then(function(){console.debug("op-change undo succeeded"),e||c.create(a.OP_CHANGE_SUCCESS)},function(){console.debug("op-change undo failed"),e||c.warning(a.OP_CHANGE_FAILURE)})},i.handlePermFailure=function(e){return console.debug("perm override required for "+e.method),s.changeOperator(e.evt).then(function(){return i.requestWithParamList(e.service,e.method,[o.token()].concat(e.params.splice(1))).finally(function(){console.debug("clearing op-change after perm override redo"),s.changeOperatorUndo(!0)})})},s}])},function(e,t){angular.module("egCoreMod").factory("egLovefield",["$q","$rootScope","egCore","$timeout",function(e,t,n,r){var o={autoId:0,cannotConnect:!1,pendingRequests:[],activeSchemas:["cache"],schemasInProgress:{},connectedSchemas:[],workerUrl:"/js/ui/default/staff/offline-db-worker.js"};return o.connectToWorker=function(){if(!o.worker){try{o.worker=new SharedWorker(o.workerUrl)}catch(e){return console.warn("SharedWorker() not supported",e),void(o.cannotConnect=!0)}o.worker.onerror=function(e){navigator.userAgent.match(/PhantomJS/)||console.error("Error loading shared worker",e),o.cannotConnect=!0},o.worker.port.addEventListener("message",function(e){var t=e.data,n=t.id,r=o.pendingRequests.filter(function(e){return e.id===n})[0];if(!r)return void console.error("Recieved response for unknown request "+n);"OK"===t.status?r.deferred.resolve(t.result):(console.error("worker request failed with "+t.error),r.deferred.reject(t.error))}),o.worker.port.start()}},o.connectToSchemas=function(){if(o.connectToWorker(),o.cannotConnect)return e.reject();var t=[];return o.activeSchemas.forEach(function(e){t.push(o.connectToSchema(e))}),e.all(t).then(function(){},function(){o.cannotConnect=!0})},o.request=function(e){return o.connectToSchemas().then(function(){return o.relayRequest(e)})},o.relayRequest=function(t){var n=e.defer(),r=o.autoId++;return t.id=r,o.pendingRequests.push({id:r,deferred:n}),o.worker.port.postMessage(t),n.promise},o.connectToSchema=function(t){if(o.connectedSchemas.indexOf(t)>=0)return e.when();if(o.schemasInProgress[t])return o.schemasInProgress[t];var n=e.defer();return o.relayRequest({schema:t,action:"createSchema"}).then(function(){return o.relayRequest({schema:t,action:"connect"})},n.reject).then(function(){o.connectedSchemas.push(t),delete o.schemasInProgress[t],n.resolve()},n.reject),o.schemasInProgress[t]=n.promise},o.isCacheGood=function(e){return o.request({schema:"cache",table:"CacheDate",action:"selectWhereEqual",field:"type",value:e}).then(function(e){var t=e[0];return!!t&&(new Date).getTime()-t.cachedate.getTime()<=864e5})},o.destroyPendingOfflineXacts=function(){return o.request({schema:"offline",table:"OfflineXact",action:"deleteAll"}).then(function(){return o.request({schema:"cache",table:"CacheDate",action:"deleteWhereEqual",field:"type",value:"_offlineXact"})})},o.havePendingOfflineXacts=function(){return o.request({schema:"cache",table:"CacheDate",action:"selectWhereEqual",field:"type",value:"_offlineXact"}).then(function(e){return e[0]?e[0].cachedate:null})},o.retrievePendingOfflineXacts=function(){return o.request({schema:"offline",table:"OfflineXact",action:"selectAll"}).then(function(e){return e.map(function(e){return e.value})})},o.addOfflineXact=function(e){return o.request({schema:"offline",table:"OfflineXact",action:"insertOrReplace",rows:[{value:e}]}).then(function(){return o.request({schema:"cache",table:"CacheDate",action:"insertOrReplace",rows:[{type:"_offlineXact",cachedate:new Date}]})})},o.populateBlockList=function(){return o.request({action:"populateBlockList",authtoken:n.auth.token()})},o.testOfflineBlock=function(e){return o.request({schema:"offline",table:"OfflineBlocks",action:"selectWhereEqual",field:"barcode",value:e}).then(function(e){return 0===e.length?null:e[0].reason})},o.setStatCatsCache=function(t){if(lf.isOffline||!t||0===t.length||o.cannotConnect)return e.when();var r=t.map(function(e){return{id:e.id(),value:n.idl.toHash(e)}});return o.request({schema:"cache",table:"StatCat",action:"insertOrReplace",rows:r})},o.getStatCatsCache=function(){return o.request({schema:"cache",table:"StatCat",action:"selectAll"}).then(function(e){var t=[];return e.forEach(function(e){var r=n.idl.fromHash("actsc",e.value);Array.isArray(r.default_entries())&&r.default_entries(r.default_entries().map(function(e){return n.idl.fromHash("actsced",e)})),Array.isArray(r.entries())&&r.entries(r.entries().map(function(e){return n.idl.fromHash("actsce",e)})),t.push(r)}),t})},o.setSettingsCache=function(t){if(lf.isOffline||o.cannotConnect)return e.when();var n=[];return angular.forEach(t,function(e,t){n.push({name:t,value:JSON.stringify(e)})}),o.request({schema:"cache",table:"Setting",action:"insertOrReplace",rows:n})},o.getSettingsCache=function(e){var t;return t=e&&e.length?o.request({schema:"cache",table:"Setting",action:"selectWhereIn",field:"name",value:e}):o.request({schema:"cache",table:"Setting",action:"selectAll"}),t.then(function(e){return e.forEach(function(e){e.value=JSON.parse(e.value)}),e})},o.setListInOfflineCache=function(t,r){return lf.isOffline||o.cannotConnect?e.when():o.isCacheGood(t).then(function(e){if(!e){var a=n.idl.classes[t].pkey,i=Object.values(r).map(function(e){return{type:t,id:""+e[a](),object:n.idl.toHash(e)}});return o.request({schema:"cache",table:"Object",action:"insertOrReplace",rows:i}).then(function(e){return o.request({schema:"cache",table:"CacheDate",action:"insertOrReplace",rows:[{type:t,cachedate:new Date}]})})}})},o.getListFromOfflineCache=function(e){return o.request({schema:"cache",table:"Object",action:"selectWhereEqual",field:"type",value:e}).then(function(t){return t.map(function(t){return n.idl.fromHash(e,t.object)})})},o.reconstituteList=function(t){return lf.isOffline?(console.debug("egLovefield reading "+t+" list"),o.getListFromOfflineCache(t).then(function(r){return n.env.absorbList(r,t,!0),e.when(!0)})):e.when(!1)},o.reconstituteTree=function(t){if(lf.isOffline){console.debug("egLovefield reading "+t+" tree");var r=n.idl.classes[t].pkey,a="parent";return"aou"==t&&(a="parent_ou"),o.getListFromOfflineCache(t).then(function(o){var i={},c=null;return angular.forEach(o,function(e){"aou"==t&&e.ou_type()&&e.ou_type(n.idl.fromHash("aout",e.ou_type())),i[""+e[r]()]=e,e[a]()?angular.isObject(e[a]())&&e[a](e[a]()[r]()):c=e}),angular.forEach(o,function(e){e.children([]),e.children(o.filter(function(t){return t[a]()==e[r]()}))}),angular.forEach(o,function(e){e[a]()&&e[a](i[""+e[a]()])}),n.env.absorbTree(c,t,!0),e.when(!0)})}return e.when(!1)},o}])}],[0]);